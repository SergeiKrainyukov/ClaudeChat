# RAG Чат с документами

## Описание

Добавлен новый экран RAG (Retrieval Augmented Generation) чата, который позволяет:
- Загружать документы в формате Markdown (.md)
- Задавать вопросы по загруженным документам
- Получать ответы с указанием источников и степени релевантности
- Управлять загруженными документами (просмотр, удаление)

## Компоненты

### 1. API Модели (EmbeddingModels.kt)
Определяет модели данных для работы с Embedding Server:
- `UploadDocumentRequest` / `UploadDocumentResponse` - загрузка документов
- `AskQuestionRequest` / `AskQuestionResponse` - вопросы с RAG
- `Source` - источник ответа с метаданными
- `DocumentInfo` - информация о документе
- `HealthResponse` - статус сервера

### 2. API Сервис (EmbeddingApiService.kt)
Retrofit интерфейс для работы с Embedding Server:
- Загрузка документов
- Вопросы с RAG
- Управление документами
- Проверка здоровья сервера

### 3. API Клиент (EmbeddingApiClient.kt)
Настроенный Retrofit клиент для подключения к серверу на `http://10.0.2.2:8080`

### 4. Модель сообщения (RagMessage.kt)
Модель сообщения в RAG чате с поддержкой источников

### 5. ViewModel (RagChatViewModel.kt)
Управляет состоянием RAG чата:
- Отправка вопросов
- Загрузка документов
- Управление списком документов
- Проверка состояния сервера

### 6. UI Компоненты

#### RagMessageBubble.kt
Компонент отображения сообщения с:
- Основным текстом сообщения
- Списком источников (разворачиваемый)
- Карточками источников с процентом релевантности
- Временем отправки

#### RagChatScreen.kt
Главный экран RAG чата с:
- Индикатором статуса сервера
- Списком сообщений
- Полем ввода вопроса
- Кнопками быстрых действий
- Диалогом настроек (Top-K)
- Bottom Sheet со списком документов
- Возможностью загрузки документов через file picker

## Использование

### 1. Запуск Embedding Server

Убедитесь, что embedding server запущен:
```bash
cd embedding-server
./gradlew run
```

Сервер должен быть доступен на `http://localhost:8080`

### 2. Работа с приложением

1. Запустите приложение
2. Выберите "RAG Чат с документами" в главном меню
3. Загрузите документы через кнопку "Загрузить документ"
4. Задавайте вопросы по документам
5. Просматривайте источники в ответах
6. Управляйте документами через "Просмотр документов"

### 3. Настройки

В настройках можно изменить параметр Top-K (1-10), который определяет количество наиболее релевантных фрагментов документов для поиска.

## Особенности

- **Семантический поиск**: Используется векторизация текста через Ollama (nomic-embed-text)
- **RAG**: Ответы генерируются на основе релевантных фрагментов документов
- **Источники**: Каждый ответ содержит ссылки на источники с процентом релевантности
- **Управление документами**: Полный контроль над загруженными документами

## Конфигурация

### Изменение URL сервера

Если embedding server работает на другом хосте, измените URL в `EmbeddingApiClient.kt`:

```kotlin
private const val BASE_URL = "http://10.0.2.2:8080/" // для эмулятора
// или
private const val BASE_URL = "http://localhost:8080/" // для физического устройства
```

## Структура файлов

```
app/src/main/java/com/example/claudechat/
├── api/
│   ├── EmbeddingModels.kt         # Модели данных
│   ├── EmbeddingApiService.kt     # Retrofit интерфейс
│   └── EmbeddingApiClient.kt      # HTTP клиент
├── model/
│   └── RagMessage.kt              # Модель сообщения
├── viewmodel/
│   └── RagChatViewModel.kt        # ViewModel
├── ui/
│   ├── components/
│   │   └── RagMessageBubble.kt    # Компонент сообщения
│   └── screens/
│       └── RagChatScreen.kt       # Экран чата
└── MainActivity.kt                # Навигация (обновлена)
```

## Известные ограничения

- Поддерживаются только файлы в формате Markdown (.md)
- Для работы требуется запущенный embedding server
- Используется in-memory база данных на сервере (данные не сохраняются при перезапуске)

## Дальнейшие улучшения

- Поддержка других форматов документов (PDF, TXT, DOCX)
- Кэширование документов на клиенте
- Offline режим
- Экспорт/импорт документов
- История вопросов и ответов
