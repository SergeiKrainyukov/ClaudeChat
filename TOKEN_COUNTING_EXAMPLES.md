# Примеры кода: Подсчёт токенов

## Пример 1: Короткий запрос

### Запрос
```
Привет
```

### Ожидаемый вывод в UI
```
┌────────────────────────────────┐
│ Пользователь:                  │
│ Привет                         │
└────────────────────────────────┘

┌────────────────────────────────┐
│ Claude:                        │
│ Здравствуйте! Чем могу помочь?│
│                                │
│ Токены: 5 вход / 12 выход     │
│ (всего: 17)                    │
└────────────────────────────────┘
```

### Данные от API
```json
{
  "usage": {
    "input_tokens": 5,
    "output_tokens": 12
  }
}
```

### Анализ
- **Входные токены:** 5 (слово "Привет" + контекст)
- **Выходные токены:** 12 (короткое приветствие)
- **Эффективность:** Очень быстро и дешево
- **Стоимость:** ~$0.00003

---

## Пример 2: Длинный запрос

### Запрос
```
Объясни подробно, что такое искусственный интеллект,
как он работает, какие существуют виды ИИ, где применяется,
какие есть преимущества и недостатки использования ИИ в
современном мире.
```

### Ожидаемый вывод в UI
```
┌────────────────────────────────┐
│ Пользователь:                  │
│ Объясни подробно, что такое... │
│ [длинный текст]                │
└────────────────────────────────┘

┌────────────────────────────────┐
│ Claude:                        │
│ Искусственный интеллект (ИИ)   │
│ представляет собой область...  │
│ [подробный ответ на 2-3 абзаца]│
│                                │
│ Токены: 147 вход / 423 выход  │
│ (всего: 570)                   │
└────────────────────────────────┘
```

### Данные от API
```json
{
  "usage": {
    "input_tokens": 147,
    "output_tokens": 423
  }
}
```

### Анализ
- **Входные токены:** 147 (развёрнутый вопрос)
- **Выходные токены:** 423 (подробный ответ)
- **Эффективность:** Среднее время ответа
- **Стоимость:** ~$0.007
- **Соотношение вход/выход:** 1:2.9

---

## Пример 3: Превышение лимита

### Запрос
```
Расскажи максимально подробно про историю развития компьютеров,
историю развития компьютеров, историю развития компьютеров,
[повторяется 100 раз...]
и их влияние на современное общество.
```

### Сценарий A: API возвращает ошибку
```
┌────────────────────────────────┐
│ Пользователь:                  │
│ Расскажи максимально подробно..│
│ [очень длинный текст ~3500 слов]│
└────────────────────────────────┘

┌────────────────────────────────┐
│ Ошибка:                        │
│ Request too large. The request │
│ exceeds the maximum allowed    │
│ context length.                │
└────────────────────────────────┘
```

### Сценарий B: API обрезает запрос
```
┌────────────────────────────────┐
│ Claude:                        │
│ [Ответ на первую часть запроса]│
│                                │
│ Токены: 4096 вход / 512 выход │
│ (всего: 4608)                  │
│                                │
│ Примечание: Запрос был обрезан │
│ до максимального лимита        │
└────────────────────────────────┘
```

### Данные от API (при обрезании)
```json
{
  "usage": {
    "input_tokens": 4096,
    "output_tokens": 512
  },
  "stop_reason": "max_tokens"
}
```

### Анализ
- **Входные токены:** 4096 (максимальный лимит для запроса)
- **Выходные токены:** 512 (частичный ответ)
- **Эффективность:** Медленно, возможна ошибка
- **Стоимость:** ~$0.020
- **Поведение:** API обрезает или отклоняет запрос

---

## Сравнительная таблица

| Тип запроса | Входные токены | Выходные токены | Всего | Время | Стоимость |
|-------------|----------------|-----------------|-------|-------|-----------|
| Короткий    | 5              | 12              | 17    | 1-2с  | $0.00003  |
| Средний     | 50             | 150             | 200   | 2-4с  | $0.0028   |
| Длинный     | 150            | 450             | 600   | 4-8с  | $0.0072   |
| Очень длинный| 500           | 800             | 1300  | 8-15с | $0.013    |
| Превышение  | 4096           | 512 или ошибка  | ?     | >15с  | $0.020    |

## Как считаются токены

### Для английского текста
```
"Hello, how are you?" ≈ 5 токенов
- "Hello" = 1 токен
- "," = 1 токен
- "how" = 1 токен
- "are" = 1 токен
- "you" = 1 токен
```

### Для русского текста
```
"Привет, как дела?" ≈ 8-10 токенов
- Кириллица требует больше токенов
- 1 русское слово ≈ 1.5-2 токена
```

### Формула расчёта
```
Приблизительно:
- Английский: 1 токен ≈ 0.75 слов
- Русский: 1 токен ≈ 0.5 слов
- Код: 1 токен ≈ 1 символ или меньше
```

## Интеграция в код

### Отображение в MessageBubble.kt
```kotlin
// Показываем информацию о токенах только для сообщений ассистента
if (!message.isUser && message.totalTokens > 0) {
    Spacer(modifier = Modifier.height(4.dp))
    Text(
        text = "Токены: ${message.inputTokens} вход / ${message.outputTokens} выход (всего: ${message.totalTokens})",
        style = MaterialTheme.typography.labelSmall,
        color = MessageTextAssistant.copy(alpha = 0.7f)
    )
}
```

### Извлечение из API в ChatRepository.kt
```kotlin
// Извлекаем информацию о токенах
val inputTokens = response.usage?.inputTokens ?: 0
val outputTokens = response.usage?.outputTokens ?: 0
val totalTokens = inputTokens + outputTokens

Result.success(
    MessageWithConfidence(
        text = assistantMessage,
        confidence = confidence,
        inputTokens = inputTokens,
        outputTokens = outputTokens,
        totalTokens = totalTokens
    )
)
```

## Тестовые кнопки в UI

### Код кнопок в ChatScreen.kt
```kotlin
LazyRow(
    horizontalArrangement = Arrangement.spacedBy(8.dp),
    contentPadding = PaddingValues(horizontal = 4.dp)
) {
    item {
        AssistChip(
            onClick = { viewModel.sendMessage("Привет") },
            label = { Text("Короткий запрос") },
            enabled = !isLoading
        )
    }
    item {
        AssistChip(
            onClick = {
                viewModel.sendMessage(
                    "Объясни подробно, что такое искусственный интеллект..."
                )
            },
            label = { Text("Длинный запрос") },
            enabled = !isLoading
        )
    }
    item {
        AssistChip(
            onClick = {
                val longPrompt = buildString {
                    append("Расскажи максимально подробно про ")
                    repeat(100) {
                        append("историю развития компьютеров, ")
                    }
                    append("и их влияние на современное общество.")
                }
                viewModel.sendMessage(longPrompt)
            },
            label = { Text("Превышение лимита") },
            enabled = !isLoading
        )
    }
}
```

## Рекомендации по использованию

1. **Для быстрых вопросов:** используйте короткие запросы (5-50 токенов)
2. **Для подробных ответов:** используйте средние запросы (50-200 токенов)
3. **Избегайте:** очень длинных запросов (>1000 токенов) без необходимости
4. **Оптимизация:** краткие, чёткие вопросы дают лучшие результаты

## Выводы

- ✅ Короткие запросы эффективнее по стоимости и скорости
- ✅ Длинные запросы дают более подробные ответы
- ⚠️ Превышение лимита может привести к ошибкам
- ⚠️ Русский текст требует больше токенов, чем английский