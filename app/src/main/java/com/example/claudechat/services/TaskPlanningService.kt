package com.example.claudechat.services

import com.example.claudechat.api.ClaudeApiClient
import com.example.claudechat.api.ClaudeMessage
import com.example.claudechat.api.ClaudeRequest

/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ Claude API
 */
class TaskPlanningService {

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–∞—á –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
     * @param notificationMessage –¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å –∑–∞–¥–∞—á–∞–º–∏
     * @return –¢–µ–∫—Å—Ç –ø–ª–∞–Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
     */
    suspend fun generateTaskPlan(notificationMessage: String): Result<String> {
        return try {
            val prompt = buildPrompt(notificationMessage)

            val request = ClaudeRequest(
                model = "claude-sonnet-4-20250514",
                max_tokens = 4096,
                messages = listOf(
                    ClaudeMessage(
                        role = "user",
                        content = prompt
                    )
                ),
                temperature = 0.7
            )

            val response = ClaudeApiClient.apiService.sendMessage(request)

            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –ø–µ—Ä–≤–æ–≥–æ content block
            val planText = response.content.firstOrNull()?.text
                ?: return Result.failure(Exception("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Claude"))

            Result.success(planText)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    /**
     * –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è Claude —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –∫ –ø–ª–∞–Ω—É
     */
    private fun buildPrompt(notificationMessage: String): String {
        return """
            –ù–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á —Å–æ—Å—Ç–∞–≤—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –∏—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

            –ó–ê–î–ê–ß–ò:
            $notificationMessage

            –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ü–õ–ê–ù–£:
            1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤—Å–µ –∑–∞–¥–∞—á–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏ –∏—Ö –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã (–≤—ã—Å–æ–∫–∏–π, —Å—Ä–µ–¥–Ω–∏–π, –Ω–∏–∑–∫–∏–π)
            2. –£—Å—Ç–∞–Ω–æ–≤–∏ –ª–æ–≥–∏—á–µ—Å–∫—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            3. –í—ã–¥–µ–ª–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏ (–∫–∞–∫–∏–µ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞)
            4. –î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏ —É–∫–∞–∂–∏:
               - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (üî¥ –≤—ã—Å–æ–∫–∏–π / üü° —Å—Ä–µ–¥–Ω–∏–π / üü¢ –Ω–∏–∑–∫–∏–π)
               - –û—Ü–µ–Ω–∫—É —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (–ø—Ä–æ—Å—Ç–∞—è/—Å—Ä–µ–¥–Ω—è—è/—Å–ª–æ–∂–Ω–∞—è)
               - –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
               - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é
            5. –°–≥—Ä—É–ø–ø–∏—Ä—É–π –∑–∞–¥–∞—á–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ
            6. –ü—Ä–µ–¥–ª–æ–∂–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

            –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
            –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –ø–ª–∞–Ω —Ç–∞–∫, —á—Ç–æ–±—ã –µ–≥–æ –±—ã–ª–æ —É–¥–æ–±–Ω–æ —á–∏—Ç–∞—Ç—å –≤ PDF —Ñ–æ—Ä–º–∞—Ç–µ.
            –ò—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–æ–ª–æ–≤–∫–∏, –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏ –∏ —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏.

            –ù–∞—á–Ω–∏ —Å –∫—Ä–∞—Ç–∫–æ–≥–æ —Ä–µ–∑—é–º–µ, –∑–∞—Ç–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω, –≤ –∫–æ–Ω—Ü–µ - –æ–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
        """.trimIndent()
    }
}
