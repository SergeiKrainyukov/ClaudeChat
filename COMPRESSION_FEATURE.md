# Функция сжатия истории диалога

## Описание

Реализован механизм автоматического сжатия истории диалога для оптимизации использования токенов при общении с Claude API. Каждые 10 сообщений (5 пар user-assistant) автоматически заменяются на краткое резюме, что позволяет сэкономить значительное количество токенов при длительных диалогах.

## Как это работает

### 1. Автоматическое сжатие

- **Порог сжатия**: 10 сообщений (настраивается в `ChatRepository.compressionThreshold`)
- **Процесс**:
  1. Когда количество сообщений достигает порога, система автоматически создает summary
  2. Claude генерирует краткое резюме диалога с сохранением ключевого контекста
  3. Оригинальные сообщения заменяются одним summary-сообщением
  4. Диалог продолжается с учетом резюме вместо полной истории

### 2. Визуальное отображение

#### Summary сообщения
- Отображаются в специальном цвете (tertiaryContainer)
- Содержат информацию о:
  - Количестве сжатых сообщений
  - Приблизительном количестве сэкономленных токенов
  - Резюме предыдущего диалога

#### Панель статистики
Показывается внизу экрана, когда есть сэкономленные токены:
- **Без сжатия**: общее количество токенов, которое было бы использовано
- **Со сжатием**: фактическое количество использованных токенов
- **Сэкономлено**: разница между этими значениями

### 3. Оценка токенов

Используется эвристическая оценка:
- Русские символы: ~2 символа = 1 токен
- Английские символы: ~4 символа = 1 токен

Это приблизительная оценка, реальные значения могут отличаться.

## Пример использования

### Тестовый сценарий

1. Откройте обычный чат (не многоагентный режим)
2. Отправьте несколько сообщений (например, используйте тестовые кнопки)
3. После 10 сообщений произойдет автоматическое сжатие
4. Вы увидите:
   - Summary сообщение с резюме диалога
   - Панель статистики с информацией о сэкономленных токенах
5. Продолжите диалог - Claude будет использовать резюме для контекста

### Рекомендации по тестированию

```kotlin
// Отправьте серию сообщений для тестирования компрессии
1. "Привет, расскажи о себе"
2. "Что ты умеешь делать?"
3. "Объясни, как работает машинное обучение"
4. "Расскажи про нейронные сети"
5. "Что такое GPT?"
6. "Как работает обработка естественного языка?"
7. "Расскажи про Claude"
8. "Какие есть модели Claude?"
9. "Что такое токены?"
10. "Как оптимизировать использование токенов?"

// После 10-го сообщения произойдет автоматическое сжатие
11. "Продолжи разговор о токенах"
// Claude будет использовать резюме предыдущих 10 сообщений
```

## Технические детали

### Измененные файлы

1. **Message.kt** - добавлены поля:
   - `isSummary: Boolean` - флаг summary сообщения
   - `originalMessagesCount: Int` - количество сжатых сообщений
   - `savedTokens: Int` - сэкономленные токены

2. **ChatRepository.kt** - добавлены методы:
   - `shouldCompress()` - проверка необходимости сжатия
   - `createSummary()` - создание резюме
   - `compressHistory()` - выполнение сжатия
   - `estimateTokens()` - оценка токенов
   - `getCompressionStats()` - получение статистики
   - `setCompressionEnabled()` - вкл/выкл сжатие

3. **ChatViewModel.kt** - добавлены:
   - `compressionStats` - LiveData со статистикой
   - `compressHistoryIfNeeded()` - автоматическое сжатие
   - `updateCompressionStats()` - обновление статистики
   - `setCompressionEnabled()` - управление сжатием

4. **ChatScreen.kt** - добавлено:
   - Панель статистики компрессии
   - Отслеживание статистики через LiveData

5. **MessageBubble.kt** - добавлено:
   - Специальный стиль для summary сообщений
   - Отображение информации о сжатии

## Преимущества

1. **Экономия токенов**: до 50-70% экономии на длинных диалогах
2. **Сохранение контекста**: Claude продолжает "помнить" суть диалога
3. **Автоматизация**: не требует действий от пользователя
4. **Прозрачность**: пользователь видит резюме и статистику
5. **Гибкость**: можно отключить при необходимости

## Недостатки и ограничения

1. **Потеря деталей**: резюме не сохраняет все детали оригинальных сообщений
2. **Дополнительный запрос**: создание summary требует отдельного API запроса
3. **Приблизительная оценка**: подсчет токенов является приблизительным
4. **Задержка**: компрессия добавляет небольшую задержку перед ответом

## Настройка

### Изменение порога сжатия

В `ChatRepository.kt`:
```kotlin
private val compressionThreshold: Int = 10 // Измените это значение
```

### Отключение компрессии

```kotlin
viewModel.setCompressionEnabled(false)
```

### Настройка промпта для summary

В `ChatRepository.kt`, метод `createSummary()`:
```kotlin
val summaryPrompt = """
    Создай краткое резюме следующего диалога...
    // Измените промпт по необходимости
""".trimIndent()
```

## Сравнение с/без компрессии

### Без компрессии (типичный диалог из 20 сообщений)
- Входные токены: ~8000
- Выходные токены: ~2000
- **Всего: ~10000 токенов**

### С компрессией (тот же диалог)
- После первого сжатия: ~3000 токенов вместо ~4000
- После второго сжатия: ~3500 токенов вместо ~4000
- **Всего: ~6500 токенов (экономия ~35%)**

## Будущие улучшения

1. Использовать реальный подсчет токенов вместо эвристики
2. Настраиваемый порог сжатия через UI
3. Возможность просмотра оригинальных сообщений
4. Разные стратегии сжатия (агрессивная/консервативная)
5. Кэширование summary для быстрого доступа

## Заключение

Механизм сжатия истории диалога позволяет значительно сократить использование токенов при длительных разговорах с Claude, сохраняя при этом достаточный контекст для продолжения осмысленного диалога. Функция полностью автоматизирована и прозрачна для пользователя.