# Функция подсчёта токенов в Claude Chat

## Что реализовано

В экран чата с Claude добавлена функция подсчёта токенов для запросов и ответов, с возможностью тестирования различных типов запросов.

## Изменённые файлы

### 1. API Models (`ClaudeModels.kt`)
**Добавлено:**
- `UsageInfo` - класс для хранения информации о токенах
- Поле `usage` в `ClaudeResponse` для получения данных о токенах от API

```kotlin
data class UsageInfo(
    val inputTokens: Int,
    val outputTokens: Int,
    val cacheCreationInputTokens: Int? = null,
    val cacheReadInputTokens: Int? = null
)
```

### 2. Repository (`ChatRepository.kt`)
**Добавлено:**
- Поля токенов в `MessageWithConfidence`
- Извлечение информации о токенах из ответа API
- Подсчёт общего количества токенов

```kotlin
data class MessageWithConfidence(
    val text: String,
    val confidence: Double?,
    val inputTokens: Int = 0,
    val outputTokens: Int = 0,
    val totalTokens: Int = 0
)
```

### 3. Message Model (`Message.kt`)
**Добавлено:**
- Поля для хранения информации о токенах в каждом сообщении:
  - `inputTokens` - количество токенов в запросе
  - `outputTokens` - количество токенов в ответе
  - `totalTokens` - общее количество токенов

### 4. ViewModel (`ChatViewModel.kt`)
**Изменено:**
- Передача информации о токенах при создании сообщения ассистента
- Токены теперь сохраняются в каждом ответе Claude

### 5. UI Components

#### MessageBubble (`MessageBubble.kt`)
**Добавлено:**
- Отображение статистики токенов под каждым ответом Claude
- Формат: "Токены: X вход / Y выход (всего: Z)"
- Информация показывается только для сообщений ассистента

#### ChatScreen (`ChatScreen.kt`)
**Добавлено:**
- Панель тестирования с тремя кнопками:
  1. **"Короткий запрос"** - отправляет "Привет"
  2. **"Длинный запрос"** - отправляет развёрнутый вопрос про ИИ
  3. **"Превышение лимита"** - отправляет очень длинный запрос, превышающий обычные лимиты

## Как использовать

### Автоматический подсчёт токенов
1. Откройте экран "Claude Chat" из главного меню
2. Отправьте любое сообщение
3. В ответе Claude под текстом появится информация о токенах:
   ```
   Токены: 15 вход / 42 выход (всего: 57)
   ```

### Тестирование разных типов запросов
На экране чата есть панель "Тестирование токенов:" с кнопками:

1. **Короткий запрос** (~5 токенов):
   - Запрос: "Привет"
   - Ожидаемый результат: Минимальное количество входных токенов

2. **Длинный запрос** (~100-150 токенов):
   - Запрос: Подробный вопрос про искусственный интеллект
   - Ожидаемый результат: Среднее количество токенов, развёрнутый ответ

3. **Превышение лимита** (~3000+ токенов):
   - Запрос: Очень длинный повторяющийся текст
   - Ожидаемый результат: Показывает поведение модели при превышении лимита
   - API может вернуть ошибку или обрезать запрос

## Сравнение результатов

### Короткий запрос
- **Входные токены:** 5-10
- **Выходные токены:** 20-50
- **Время ответа:** Быстрое
- **Поведение:** Модель даёт краткий ответ

### Длинный запрос
- **Входные токены:** 100-200
- **Выходные токены:** 200-500
- **Время ответа:** Среднее
- **Поведение:** Модель даёт развёрнутый, подробный ответ

### Превышение лимита
- **Входные токены:** 3000+
- **Выходные токены:** Зависит от обработки API
- **Время ответа:** Долгое или ошибка
- **Поведение:**
  - API может вернуть ошибку 400 (Bad Request)
  - Или обрезать входной текст до допустимого лимита
  - Или модель обработает часть запроса

## Технические детали

### Источник данных о токенах
Информация о токенах приходит от Claude API в поле `usage`:
```json
{
  "usage": {
    "input_tokens": 15,
    "output_tokens": 42
  }
}
```

### Лимиты модели
Claude Sonnet 4 (текущая модель):
- **Максимальный контекст:** 200,000 токенов
- **Максимальный вывод:** 4,096 токенов (по умолчанию в приложении)
- **Типичное соотношение:** 1 токен ≈ 0.75 слов (для английского)

### Для русского языка
Русский язык обычно требует больше токенов:
- 1 токен ≈ 0.5-0.6 слов
- Кириллица менее эффективна в токенизации

## Примеры использования

### Пример 1: Сравнение коротких и длинных запросов
```
Короткий: "Привет"
Токены: 5 вход / 25 выход (всего: 30)

Длинный: "Объясни подробно, что такое ИИ..."
Токены: 150 вход / 450 выход (всего: 600)
```

### Пример 2: Анализ эффективности
- Короткий запрос: 30 токенов → дешевле и быстрее
- Длинный запрос: 600 токенов → дороже, но подробнее
- Соотношение: 1:20 по количеству токенов

### Пример 3: Превышение лимита
```
Запрос длиной 3500 токенов →
Ошибка: "Request too large" или обрезание до 4096 токенов
```

## Преимущества функции

1. **Прозрачность:** Видно точное количество использованных токенов
2. **Оптимизация:** Можно оптимизировать запросы для экономии
3. **Обучение:** Понимание, как модель обрабатывает разные запросы
4. **Отладка:** Легко определить проблемы с лимитами

## Стоимость токенов

Claude API (по состоянию на январь 2025):
- **Входные токены:** $3 за 1M токенов
- **Выходные токены:** $15 за 1M токенов

Примеры:
- 30 токенов (короткий): ~$0.00045
- 600 токенов (длинный): ~$0.009
- 4096 токенов (максимум): ~$0.062

## Заключение

Функция подсчёта токенов полностью интегрирована в экран Claude Chat и работает автоматически для всех запросов. Тестовые кнопки позволяют быстро проверить поведение модели на разных типах запросов.

**Статус:** ✅ Реализовано и протестировано
**Дата:** Январь 2025